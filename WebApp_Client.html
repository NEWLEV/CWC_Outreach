<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      /* Light Mode Variables */
      --primary: #3b82f6; --primary-dark: #2563eb; 
      --bg: #f3f4f6; --sidebar: #ffffff; --input-bg: #ffffff;
      --text: #1f2937; --text-light: #6b7280; --border: #e5e7eb; --danger: #ef4444;
      
      /* Button Colors */
      --btn-success: #10b981; --btn-success-dark: #059669;
      --btn-purple: #8b5cf6; --btn-purple-dark: #7c3aed;
      
      /* Status Colors */
      --status-new: #dbeafe; --text-new: #1e40af;
      --status-review: #fef3c7; --text-review: #92400e;
      --status-pharm: #d1fae5; --text-pharm: #065f46;
      
      --highlight-bg: #eff6ff; --highlight-border: #60a5fa;
      --badge-mail-bg: #7c3aed; --badge-mail-text: #fff;
      --badge-meds-bg: #db2777; --badge-meds-text: #fff;
    }

    .dark-mode { 
      /* Dark Mode Variables */
      --bg: #111827;        
      --sidebar: #1f2937;   
      --input-bg: #374151;  
      --text: #f9fafb; 
      --text-light: #9ca3af; 
      --border: #4b5563;    
      
      --status-new: #1e3a8a; --text-new: #bfdbfe; 
      --status-review: #78350f; --text-review: #fcd34d; 
      --status-pharm: #064e3b; --text-pharm: #6ee7b7;
      
      --highlight-bg: #1e293b; --highlight-border: #3b82f6; 
    }
    
    html, body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: grid; grid-template-columns: 340px 1fr; transition: background 0.3s, color 0.3s; }
    
    /* Sidebar Styles */
    aside { background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; height: 100%; overflow: hidden; box-shadow: 2px 0 10px rgba(0,0,0,0.02); transition: background 0.3s; }
    .sb-header { padding: 20px; border-bottom: 1px solid var(--border); background: var(--sidebar); }
    .sb-header h3 { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; color: var(--primary); }
    
    .search-box { padding: 15px; display: flex; gap: 8px; align-items: center; border-bottom: 1px solid var(--border); }
    #search { flex: 1; min-width: 0; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 13px; transition: all 0.2s; }
    #search:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    
    .tabs { display: flex; padding: 0 15px; border-bottom: 1px solid var(--border); gap: 15px; }
    .tab { padding: 12px 5px; cursor: pointer; font-weight: 600; color: var(--text-light); border-bottom: 3px solid transparent; font-size: 13px; transition: all 0.2s; }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    
    .list-container { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }
    
    /* Patient List Item */
    .patient-item { padding: 14px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; background: var(--sidebar); box-shadow: 0 1px 2px rgba(0,0,0,0.03); border: 1px solid var(--border); }
    .patient-item:hover { background: var(--bg); transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .patient-item.selected { background: var(--primary); color: white; border-color: var(--primary-dark); }
    .patient-item.selected .sub-text { color: rgba(255,255,255,0.8); }
    .patient-item.selected .badge { background: rgba(255,255,255,0.2); color: white; }
    .patient-item.unread { border-left: 4px solid var(--primary); background: var(--highlight-bg); }
    
    .sub-text { font-size: 11px; color: var(--text-light); display: flex; justify-content: space-between; margin-top: 8px; font-weight: 500; }
    
    /* Chat Section */
    .chat-section { height: 35%; min-height: 250px; border-top: 1px solid var(--border); display: flex; flex-direction: column; background: var(--sidebar); transition: background 0.3s; }
    .chat-header { padding: 12px 15px; background: var(--bg); font-size: 11px; font-weight: 800; border-bottom: 1px solid var(--border); color: var(--text-light); display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; font-size: 13px; background: var(--sidebar); }
    .chat-input-area { padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: var(--sidebar); }
    .msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; word-wrap: break-word; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .msg.system { align-self: center; color: var(--text-light); font-style: italic; font-size: 11px; background: transparent; text-align: center; box-shadow: none; }
    .msg.out { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
    .msg.in { align-self: flex-start; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
    .msg-meta { font-size: 10px; opacity: 0.8; margin-bottom: 3px; display: block; font-weight: 600; }
    
    /* Main Area */
    main { display: flex; flex-direction: column; height: 100%; overflow: hidden; background: var(--bg); transition: background 0.3s; }
    header { background: var(--sidebar); padding: 16px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: background 0.3s; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    
    .content-area { flex: 1; overflow-y: auto; padding: 30px; position: relative; max-width: 1200px; margin: 0 auto; width: 100%; }
    .card { background: var(--sidebar); border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); transition: opacity 0.2s, background 0.3s; border: 1px solid var(--border); }
    
    /* Form Styles */
    .form-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 12px; 
      margin-top: 15px; 
    }
    .form-group { margin-bottom: 8px; }
    .form-group label { 
      display: block; font-size: 11px; 
      font-weight: 700; text-transform: uppercase; margin-bottom: 4px; 
      color: var(--text-light); letter-spacing: 0.5px; 
    }
    .full-width { grid-column: 1 / -1; }
    
    /* INPUT FIELDS */
    input, select, textarea { 
      width: 100%; padding: 8px 10px; 
      border-radius: 6px; 
      border: 1px solid var(--border); 
      background: var(--input-bg); 
      color: var(--text); 
      font-size: 13px; 
      transition: all 0.2s; 
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    input:disabled, select:disabled, textarea:disabled { opacity: 0.6; cursor: not-allowed; border-style: dashed; }
    
    .urgent-check { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 13px; cursor: pointer; color: var(--text); transition: color 0.2s; }
    .urgent-check input { width: 16px; height: 16px; accent-color: var(--danger); cursor: pointer; }
    .urgent-check:hover { color: var(--danger); }

    /* Buttons */
    .btn { 
      padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 13px;
      display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; 
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3); }
    .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4); }
    
    .btn-secondary { background: var(--sidebar); border: 1px solid var(--border); color: var(--text); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .btn-secondary:hover { background: var(--bg); border-color: var(--text-light); }

    .btn-success { background: var(--btn-success); color: white; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); }
    .btn-success:hover { background: var(--btn-success-dark); box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4); }

    .btn-purple { background: var(--btn-purple); color: white; box-shadow: 0 2px 5px rgba(139, 92, 246, 0.3); }
    .btn-purple:hover { background: var(--btn-purple-dark); box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4); }
    
    .action-bar {
      margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);
      display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; 
    }
    .btn-action {
      padding: 12px 16px; font-size: 14px; font-weight: 800; 
      text-transform: uppercase; letter-spacing: 0.5px;
      flex: 1; min-width: 160px; max-width: 300px; justify-content: center;
    }
    
    /* Badges */
    .badge { font-size: 10px; padding: 3px 8px; border-radius: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
    .bg-new { background: var(--status-new); color: var(--text-new); }
    .bg-review { background: var(--status-review); color: var(--text-review); }
    .bg-pharm { background: var(--status-pharm); color: var(--text-pharm); }
    .bg-mail { background: var(--badge-mail-bg); color: var(--badge-mail-text); }
    .bg-meds { background: var(--badge-meds-bg); color: var(--badge-meds-text); }

    .hidden { display: none !important; }
    .blurred { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
    .loader-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(2px); }
    .dark-mode .loader-overlay { background: rgba(0,0,0,0.7); }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Toast */
    #toast { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(20px); background: #1f2937; color: white; padding: 12px 24px; border-radius: 30px; opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; z-index: 100; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 14px; display: flex; align-items: center; gap: 10px; }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.error { background: var(--danger); }
    
    /* Pharmacy Grid - UPDATED TO 3 COLUMNS */
    .pharm-info-grid { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 12px; 
      font-size: 13px; 
      background: var(--bg); 
      padding: 15px; 
      border-radius: 8px; 
      border: 1px solid var(--border); 
    }
    @media (max-width: 768px) {
      .pharm-info-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 480px) {
      .pharm-info-grid { grid-template-columns: 1fr; }
    }

    .pharm-item { padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .pharm-item strong { display: block; color: var(--text-light); font-size: 10px; font-weight: 700; margin-bottom: 2px; text-transform: uppercase; }
    .pharm-item span { font-weight: 500; color: var(--text); font-size: 13px; }
    
    /* New Section Header in Pharm Grid */
    .pharm-section-header { grid-column: 1 / -1; font-size: 12px; font-weight: 800; color: var(--primary); margin-top: 10px; padding-bottom: 4px; border-bottom: 1px solid var(--border); text-transform: uppercase; letter-spacing: 0.5px; }
    .pharm-section-header:first-child { margin-top: 0; }

    .pharm-3-col-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; grid-column: 1 / -1; }
    
    /* Modal */
    .modal-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index: 200; backdrop-filter: blur(4px); }
    .modal-content { background: var(--sidebar); padding: 30px; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px; }
  </style>
</head>
<body>
  <aside>
    <div class="sb-header">
      <h3>CWC Outreach</h3>
      <div class="sub-text" id="user-email">Loading...</div>
    </div>
    <div class="search-box">
      <input type="text" id="search" placeholder="Search Name or PRN..." onkeyup="handleSearch()">
      <button class="btn btn-secondary" style="padding:8px;" id="btn-sort" onclick="toggleSort()" title="Sort Date">‚¨áÔ∏è</button>
      <button class="btn btn-secondary" style="padding:8px;" onclick="toggleBlur()" title="Toggle Privacy Blur">üëÅÔ∏è</button>
    </div>
    <div class="tabs">
      <div id="tab-active" class="tab active" onclick="switchList('active')">Active</div>
      <div id="tab-archive" class="tab" onclick="switchList('archive')">Archive</div>
    </div>
    <div id="list-wrapper" class="list-container"></div>
    <div class="chat-section">
      <div class="chat-header">
        <span>Group Chat</span>
        <span onclick="refreshChat()" style="cursor:pointer; font-size:16px;" title="Refresh">‚Üª</span>
      </div>
      <div id="chat-messages" class="chat-messages">
        <div style="text-align:center; color:var(--text-light); padding:20px;">Loading chat...</div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type message..." onkeydown="checkChatSend(event)">
        <button class="btn btn-primary" style="padding: 8px 12px;" onclick="sendChat()">‚û§</button>
      </div>
    </div>
  </aside>
  <main>
    <header>
      <div class="header-actions">
        <div id="view-indicator" class="badge" style="padding: 6px 12px; font-size: 12px;">Loading...</div>
        <button class="btn btn-primary" id="btn-add-record" onclick="addRecord(event)">+ Add Record</button>
        <button class="btn btn-secondary" onclick="exportPDF()">üìÑ PDF</button>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary hidden" id="btn-switch-role" onclick="switchRole()">‚áÑ Switch View</button>
        <button class="btn btn-secondary" onclick="toggleInfo(event)">‚Ñπ Info</button>
        <button class="btn btn-secondary" onclick="init()">‚Üª Refresh</button>
        <label style="font-size:12px; font-weight:600; display:flex; align-items:center; gap:5px; cursor:pointer;"><input id="chk-theme" type="checkbox" onchange="toggleTheme()"> Dark</label>
      </div>
    </header>
    <div class="content-area" id="content-area">
      <div id="empty-state" style="text-align:center; margin-top:100px; color:var(--text-light);">
        <div style="font-size:64px; margin-bottom:20px;">üìã</div>
        <h2 style="margin-bottom: 10px;">No Record Selected</h2>
        <p style="font-size: 14px;">Select a patient from the sidebar to view or edit details.</p>
      </div>
      
      <div id="detail-card" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:start; border-bottom:1px solid var(--border); padding-bottom:15px;">
          <div>
             <h1 id="d-name" style="margin:0; font-size:24px; font-weight:800; color:var(--primary);">Name</h1>
             <div style="display:flex; align-items:center; gap:12px; margin-top:4px;">
                <span id="d-prn" style="font-weight:600; color:var(--text-light);">PRN</span>
                <div id="d-ext-status" style="display:flex; gap:5px;"></div>
             </div>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
             <span id="d-status" class="badge bg-new" style="font-size:12px; padding:6px 12px;">Status</span>
             <button class="btn btn-secondary" style="padding:6px 10px;" onclick="closeDetail()" title="Close">‚úï</button>
          </div>
        </div>

        <form id="patient-form">
          <div id="view-cwc-container">
             <div style="display:flex; justify-content:space-between; align-items:end; border-bottom:1px solid var(--border); margin-top:10px;">
               <div class="tabs" style="border-bottom:none; padding:0;">
                 <div class="tab active" onclick="showSection('patient')">Patient Info</div>
                 <div class="tab" onclick="showSection('meds')">Clinical & Meds</div>
               </div>
               <div style="padding: 0 10px 8px 0;">
                  <label class="urgent-check">
                     <input type="checkbox" name="priority_check" id="chk-priority"> üî• Urgent
                  </label>
               </div>
             </div>
             
             <div id="sec-patient" class="form-grid">
               <div class="form-group"><label>üë§ Patient Name</label><input type="text" name="patientName" class="force-upper" required></div>
               <div class="form-group"><label>üÜî PRN</label><input type="text" name="prn" class="force-upper" required></div>
               
               <div class="form-group">
                 <label>üîí Social Security</label>
                 <div style="position:relative; display:flex;">
                   <input type="password" name="ssn" id="inp-ssn" placeholder="Enter SSN">
                   <button type="button" class="btn btn-secondary" style="position:absolute; right:0; top:0; bottom:0; border-left:none; border-radius:0 6px 6px 0;" onclick="toggleSSN()">üëÅÔ∏è</button>
                 </div>
               </div>
               <div class="form-group"><label>üìÖ DOB</label><input type="date" name="dob"></div>
               <div class="form-group"><label>‚öß Sex</label><select name="sex" id="opt-sex"></select></div>
               <div class="form-group"><label>üìû Phone</label><input type="text" name="phoneNumber"></div>
               
               <div class="form-group"><label>üè† Address</label><input type="text" name="address"></div>
               <div class="form-group"><label>üìù Reason</label><input type="text" name="reason"></div>
               
               <div class="form-group full-width"><label>üì¢ Outreach Note</label><textarea name="outreachNote" rows="3"></textarea></div>
             </div>
             
             <div id="sec-meds" class="form-grid hidden">
               <div class="form-group"><label>üíä Pharmacy</label><select name="pharmacy" id="opt-pharmacy"></select></div>
               <div class="form-group"><label>ü©∫ Provider</label><select name="provider" id="opt-provider"></select></div>
               <div class="form-group"><label>üß™ Medication</label><select name="medicationDetails" id="opt-medication"></select></div>
               <div class="form-group"><label>üìä Status</label><select name="status" id="opt-status"></select></div>
               <div class="form-group"><label>üõ°Ô∏è Insurance</label><select name="insuranceName" id="opt-insurance"></select></div>
               <div class="form-group"><label>üí≥ Insurance ID</label><input type="text" name="insuranceId"></div>
               <div class="form-group full-width"><label>üóíÔ∏è Additional Notes</label><textarea name="officeNote" rows="3"></textarea></div>
             </div>
          </div>
          
          <div id="view-pharm-container" class="hidden">
             <div class="pharm-info-grid" id="pharm-info-card"></div>
             
             <h3 style="margin-top:15px; margin-bottom:10px; color:var(--primary); font-size:16px;">Pharmacy Action</h3>
             
             <div class="form-grid">
                <div class="pharm-3-col-row">
                   <div class="form-group"><label>üìú Need Script?</label><select name="needsScript" id="opt-needsScript"></select></div>
                   <div class="form-group"><label>üîÑ Updated Policy #</label><input type="text" name="policyNumber"></div>
                   <div class="form-group"><label>üîÑ Updated Insurance</label><select name="insuranceDetail" id="opt-insurance-update"></select></div>
                </div>
                <div class="form-group full-width"><label>üìù Pharmacy Notes</label><textarea name="gardenNotes" rows="3"></textarea></div>
             </div>
          </div>

          <!-- CENTERED & BOLD BUTTONS -->
          <div class="action-bar">
            <button type="button" class="btn btn-primary btn-action" id="btn-save" onclick="saveData('Save')">Save Changes</button>
            <button type="button" class="btn btn-success btn-action" id="btn-submit" onclick="saveData('Submit to Pharmacy')">Submit to Pharmacy</button>
            <button type="button" class="btn btn-purple btn-action" id="btn-outreach" onclick="saveData('Outreach Update')">Send Outreach Update</button>
            <button type="button" class="btn btn-primary btn-action hidden" id="btn-pharm-update" onclick="saveData('Pharmacy Update')">Submit Pharmacy Update</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <div id="loader" class="loader-overlay hidden"><div class="spinner"></div><p style="margin-top:15px; font-weight:600; color:var(--primary);">Processing...</p></div>
  <div id="toast">Notification</div>
  <div id="info-modal" class="modal-backdrop hidden" onclick="toggleInfo(event)">
     <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header"><h2>Application Info</h2><button class="btn btn-secondary" onclick="toggleInfo(event)">Close</button></div>
        <div style="line-height:1.6; color:var(--text);">
           <p><strong>Status Colors:</strong> <span class="badge bg-new">New</span> <span class="badge bg-review">Review</span> <span class="badge bg-pharm">Pharmacy</span></p>
           <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
           <h4>External Data Status</h4>
           <div id="connection-log" style="font-family:monospace; font-size:11px; background:var(--bg); padding:15px; border-radius:8px; margin-top:10px; border:1px solid var(--border);">Loading...</div>
        </div>
     </div>
  </div>
  <script>
    let STATE = { records: [], archives: [], config: {}, user: {}, currentList: 'active', blur: true, selectedId: null, dataHash: "", unreadIds: new Set(), sortOrder: 'asc', chatHistory: [], externalStatus: {} };
    let pollInterval, chatInterval, notificationTimer, originalTitle = document.title;
    window.onload = init;

    function loadSettings() {
       const savedTheme = localStorage.getItem('cwc_dark_mode');
       if(savedTheme === 'true') { document.body.classList.add('dark-mode'); document.getElementById('chk-theme').checked = true; }
       const savedBlur = localStorage.getItem('cwc_blur_enabled');
       if(savedBlur !== null) STATE.blur = (savedBlur === 'true');
    }
    document.addEventListener('input', (e) => {
      if (e.target.classList.contains('force-upper')) {
        const start = e.target.selectionStart; const end = e.target.selectionEnd;
        e.target.value = e.target.value.toUpperCase(); e.target.setSelectionRange(start, end);
      }
    });
    document.addEventListener('click', (e) => {
      if (typeof AudioContext !== 'undefined' && AudioContext.state === 'suspended') new AudioContext().resume();
      const dc = document.getElementById('detail-card'), lw = document.getElementById('list-wrapper'), h = document.querySelector('header');
      if(STATE.selectedId && dc && lw && h && !dc.contains(e.target) && !lw.contains(e.target) && !h.contains(e.target) && !e.target.closest('.modal-content') && !e.target.closest('.chat-section')) {
        closeDetail();
      }
    });
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') { if(!document.getElementById('info-modal').classList.contains('hidden')) toggleInfo(); else closeDetail(); }
    });

    function init() {
      loadSettings(); toggleLoader(true);
      google.script.run.withSuccessHandler(data => {
         toggleLoader(false);
         if(data.error) return alert(data.error);
         STATE.records = data.activeRecords||[]; STATE.archives = data.archivedRecords||[]; STATE.config = data.config||{};
         STATE.user = data.user||{}; STATE.chatHistory = data.chatHistory||[]; STATE.externalStatus = data.externalStatus||{};
         
         const diagEl = document.getElementById('connection-log');
         if(data.diagnostics) diagEl.innerHTML = data.diagnostics.join('<br>');
         document.getElementById('user-email').innerText = STATE.user.email;
         const dd = data.config.dropdowns||{};
         ['sex','pharmacy','provider','medication','status','insurance','needsScript'].forEach(k => populateSelect('opt-'+k, dd[k]||[]));
         populateSelect('opt-insurance-update', dd.insurance||[]);
         setupRoleView(); renderList(); renderChat();
         setInterval(checkUpdates, 15000); setInterval(refreshChat, 30000);
      }).getInitialData();
    }
    
    function renderList() {
      const listEl = document.getElementById('list-wrapper'); listEl.innerHTML = '';
      let src = STATE.currentList === 'active' ? STATE.records : STATE.archives;
      const term = document.getElementById('search').value.toLowerCase();
      let filt = src.filter(r => (r.patientName||'').toLowerCase().includes(term) || (r.prn||'').toLowerCase().includes(term));
      
      if(STATE.user.defaultRole === 'PHARMACY' && STATE.currentList === 'active') {
         filt = filt.filter(r => r.workflowStatus === STATE.config.flags.SUBMITTED_TO_PHARMACY || r.workflowStatus === STATE.config.flags.PHARMACY_UPDATE);
      }

      filt.sort((a, b) => {
         const pA = (a.priority||'').toLowerCase() === 'urgent' ? 1 : 0;
         const pB = (b.priority||'').toLowerCase() === 'urgent' ? 1 : 0;
         if(pA !== pB) return pB - pA;
         return STATE.sortOrder === 'asc' ? new Date(a.timestamp||0) - new Date(b.timestamp||0) : new Date(b.timestamp||0) - new Date(a.timestamp||0);
      });

      filt.forEach(r => {
        const div = document.createElement('div');
        const unread = STATE.unreadIds.has(r.rowNum);
        div.className = `patient-item ${STATE.selectedId === r.rowNum ? 'selected' : ''} ${unread ? 'unread' : ''}`;
        div.onclick = (e) => { e.stopPropagation(); selectRecord(r); };
        
        let extBadgesHTML = '';
        const k = r.prn ? r.prn.toUpperCase().replace(/\s+/g, '') : "";
        if (k && STATE.externalStatus[k]) {
           STATE.externalStatus[k].forEach(s => {
              const cls = s === 'MAIL' ? 'bg-mail' : 'bg-meds';
              extBadgesHTML += `<span class="badge ${cls}" style="margin-right:4px;">${s}</span>`;
           });
        }
        
        let stCls = 'bg-new';
        if(r.workflowStatus.includes('Review')) stCls = 'bg-review';
        if(r.workflowStatus.includes('Pharmacy')) stCls = 'bg-pharm';
        const icon = (r.priority||'').toLowerCase() === 'urgent' ? 'üî• ' : '';
        
        div.innerHTML = `
           <div style="display:flex; justify-content:space-between; align-items:center;">
              <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; font-weight:600;">
                 ${extBadgesHTML}
                 <span class="${STATE.blur && STATE.selectedId !== r.rowNum ? 'blurred' : ''}">${icon}${r.patientName}</span>
              </div>
              <span class="badge ${stCls}">${r.workflowStatus?r.workflowStatus.charAt(0):'N'}</span>
           </div>
           <div class="sub-text"><span>${r.prn}</span><span>${r.timestamp ? new Date(r.timestamp).toLocaleDateString() : ''}</span></div>
        `;
        listEl.appendChild(div);
      });
    }

    function selectRecord(r) {
       STATE.selectedId = r.rowNum; renderList();
       document.getElementById('empty-state').classList.add('hidden'); 
       document.getElementById('detail-card').classList.remove('hidden');
       document.getElementById('d-name').innerText = r.patientName;
       document.getElementById('d-prn').innerText = r.prn;
       document.getElementById('d-status').innerText = r.workflowStatus;
       
       updateHeaderBadges(r);
       
       // Setup Form
       const form = document.getElementById('patient-form');
       const isPharm = STATE.user.defaultRole === 'PHARMACY';
       
       document.getElementById('view-cwc-container').classList.toggle('hidden', isPharm);
       document.getElementById('view-pharm-container').classList.toggle('hidden', !isPharm);
       
       // Populate Inputs
       Array.from(form.elements).forEach(el => {
          if(el.name && r[el.name]!==undefined) {
             if(el.type==='date' && r[el.name]) try{el.value=new Date(r[el.name]).toISOString().split('T')[0]}catch(e){el.value=r[el.name]}
             else el.value = r[el.name];
          }
       });
       
       // Handle New Priority Checkbox
       const chkPriority = document.getElementById('chk-priority');
       if (chkPriority) {
         chkPriority.checked = (r.priority === 'Urgent');
       }

       // Configure Buttons
       document.getElementById('btn-save').classList.toggle('hidden', isPharm);
       document.getElementById('btn-submit').classList.toggle('hidden', isPharm);
       document.getElementById('btn-outreach').classList.toggle('hidden', isPharm);
       document.getElementById('btn-pharm-update').classList.toggle('hidden', !isPharm);
       
       // Input Disable Logic
       const isArchive = STATE.currentList === 'archive';
       Array.from(form.elements).forEach(i => {
          i.disabled = isArchive;
          if (!isArchive && !isPharm) {
             const isPharmField = ['needsScript','insuranceDetail','gardenNotes', 'policyNumber'].includes(i.name);
             if(isPharmField) i.disabled = true;
             else i.disabled = false;
          } else if (!isArchive && isPharm) {
             const isPharmField = ['needsScript','insuranceDetail','gardenNotes', 'policyNumber'].includes(i.name);
             if(!isPharmField) i.disabled = true;
             else i.disabled = false;
          }
       });

       if(isPharm) {
          const pCard = document.getElementById('pharm-info-card');
          pCard.innerHTML = `
            <div class="pharm-section-header">Patient Details</div>
            <div class="pharm-item"><strong>üìÖ DOB</strong><span>${r.dob ? new Date(r.dob).toLocaleDateString() : '-'}</span></div>
            <div class="pharm-item"><strong>‚öß Sex</strong><span>${r.sex || '-'}</span></div>
            <div class="pharm-item"><strong>üìû Phone</strong><span>${r.phoneNumber || '-'}</span></div>
            <div class="pharm-item"><strong>üè† Address</strong><span>${r.address || '-'}</span></div>
            
            <div class="pharm-item">
              <strong>üîí SSN</strong>
              <div style="display:flex; align-items:center;">
                 <input id="pharm-ssn-view" type="password" value="${r.ssn||''}" readonly style="border:none; background:transparent; width:100%; font-size:13px; color:var(--text); padding:0;">
                 <!-- ADDED TYPE=BUTTON AND EVENT HANDLING HERE -->
                 <button type="button" class="btn btn-secondary" style="padding:2px 6px; font-size:10px; margin-left:5px;" onclick="togglePharmSSN(event)">üëÅÔ∏è</button>
              </div>
            </div>
            
            <div class="pharm-section-header">Clinical & Meds</div>
            <div class="pharm-item"><strong>üß™ Medication</strong><span>${r.medicationDetails || '-'}</span></div>
            <div class="pharm-item"><strong>ü©∫ Provider</strong><span>${r.provider || '-'}</span></div>
            <div class="pharm-item"><strong>üíä Pharmacy</strong><span>${r.pharmacy || '-'}</span></div>
            <div class="pharm-item"><strong>üìù Reason</strong><span>${r.reason || '-'}</span></div>
            <div class="pharm-item"><strong>üõ°Ô∏è Insurance</strong><span>${r.insuranceName || '-'}</span></div>
            <div class="pharm-item"><strong>üí≥ ID</strong><span>${r.insuranceId || '-'}</span></div>

            <div class="pharm-3-col-row" style="margin-top:10px; background:var(--bg); padding:10px; border-radius:5px; grid-column:1/-1;">
               <div class="pharm-section-header" style="margin:0 0 5px 0; border:none;">Notes</div>
               <div style="font-size:13px;"><strong>Outreach:</strong> ${r.outreachNote || '-'}</div>
               <div style="font-size:13px;"><strong>Office:</strong> ${r.officeNote || '-'}</div>
            </div>
          `;
       }
    }

    // Helpers
    function updateHeaderBadges(r) {
      const c = document.getElementById('d-ext-status'); c.innerHTML = '';
      const k = r.prn ? r.prn.toUpperCase().replace(/\s+/g, '') : "";
      if (k && STATE.externalStatus[k]) {
        STATE.externalStatus[k].forEach(s => {
           const sp = document.createElement('span');
           sp.className = 'badge ' + (s === 'MAIL' ? 'bg-mail' : 'bg-meds');
           sp.innerText = s;
           c.appendChild(sp);
        });
      }
    }
    function toggleLoader(s) { document.getElementById('loader').classList.toggle('hidden', !s); }
    function closeDetail() { STATE.selectedId = null; document.getElementById('detail-card').classList.add('hidden'); document.getElementById('empty-state').classList.remove('hidden'); renderList(); }
    function populateSelect(id, arr) { const s = document.getElementById(id); s.innerHTML = '<option value="">-- Select --</option>'; arr.forEach(v => { const op = document.createElement('option'); op.value=v; op.innerText=v; s.appendChild(op); }); }
    function showSection(s) {
       document.getElementById('sec-patient').classList.toggle('hidden', s!=='patient');
       document.getElementById('sec-meds').classList.toggle('hidden', s!=='meds');
       document.querySelectorAll('#view-cwc-container .tab').forEach(t => t.classList.remove('active'));
       event.target.classList.add('active');
    }
    function toast(m) { const t = document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    
    // Actions
    function addRecord(e) { e.stopPropagation(); toggleLoader(true); google.script.run.withSuccessHandler(res => { toggleLoader(false); if(!res.error) { STATE.records=res.allRecords; renderList(); selectRecord(res.updatedRecord); toast('Created'); } }).addOutreachRecord(); }
    
    function saveData(act) { 
       toggleLoader(true); 
       const f = document.getElementById('patient-form'), d={}; Array.from(f.elements).forEach(e=>{if(e.name)d[e.name]=e.value});
       
       // --- NEW VALIDATION LOGIC ---
       if (act === 'Submit to Pharmacy') {
         const requiredFields = [
           'prn', 'ssn', 'dob', 'sex', 'phoneNumber', 'address', 
           'pharmacy', 'provider', 'medicationDetails', 'status', 'insuranceName', 'insuranceId'
         ];
         
         const missing = [];
         requiredFields.forEach(field => {
           const val = d[field];
           if (!val || val.trim() === '' || val === '-- Select --' || val === '-- Select --') {
             // Simple mapping for nicer alert names
             const niceNames = {
               prn: 'PRN', ssn: 'Social Security', dob: 'Date of Birth', sex: 'Sex', 
               phoneNumber: 'Phone', address: 'Address', pharmacy: 'Pharmacy', provider: 'Provider',
               medicationDetails: 'Medication', status: 'Status', insuranceName: 'Insurance', insuranceId: 'Insurance ID'
             };
             missing.push(niceNames[field] || field);
           }
         });
         
         if (missing.length > 0) {
           toggleLoader(false);
           alert("Missing Required Fields for Pharmacy Submission:\n\n‚Ä¢ " + missing.join("\n‚Ä¢ "));
           return; // STOP execution
         }
       }
       // -----------------------------

       // Handle Urgent Checkbox specifically
       const chkPriority = document.getElementById('chk-priority');
       if (chkPriority) {
         d['priority'] = chkPriority.checked ? 'Urgent' : 'Standard';
       }

       let fn = 'saveRecordChanges';
       if(act==='Submit to Pharmacy') fn='submitToPharmacy';
       if(act==='Outreach Update') fn='sendOutreachUpdate';
       if(act==='Pharmacy Update') fn='submitPharmacyUpdate';
       google.script.run.withSuccessHandler(res => {
          toggleLoader(false); 
          if(res.error) toast('Error: '+res.error); 
          else { STATE.records=res.allRecords; selectRecord(STATE.records.find(r=>r.rowNum===STATE.selectedId)); toast(res.message); }
       })[fn](STATE.selectedId, d);
    }
    function exportPDF() { toggleLoader(true); google.script.run.withSuccessHandler(res => { toggleLoader(false); if(res.error) toast("Error: "+res.error, 'error'); else window.open(res.url, '_blank'); }).getPDFDownloadUrl(); }
    
    function checkChatSend(e) { if(e.key === 'Enter') sendChat(); }
    function sendChat() {
       const i = document.getElementById('chat-input'); const t = i.value.trim(); if(!t) return;
       STATE.chatHistory.push({sender:STATE.user.email, text:t, time:'Now'}); renderChat(); i.value='';
       google.script.run.withSuccessHandler(h=>{STATE.chatHistory=h; renderChat();}).postUserMessage(t);
    }
    function renderChat() {
       const c = document.getElementById('chat-messages'); c.innerHTML='';
       STATE.chatHistory.forEach(m => {
          const isMe = m.sender === STATE.user.email;
          const d = document.createElement('div'); d.className = `msg ${isMe?'out':'in'}`;
          d.innerHTML = `<span class="msg-meta">${m.sender.split('@')[0]}</span>${m.text}`;
          c.appendChild(d);
       });
       c.scrollTop = c.scrollHeight;
    }
    function refreshChat() { google.script.run.withSuccessHandler(h=>{if(h.length){STATE.chatHistory=h; renderChat();}}).pollChat(); }
    function checkUpdates() { google.script.run.withSuccessHandler(res=>{if(res.hasUpdate){STATE.records=res.activeRecords; renderList(); toast('Data Updated');}}).checkForUpdates(STATE.dataHash); }
    function switchRole() { STATE.user.defaultRole = STATE.user.defaultRole==='CWC'?'PHARMACY':'CWC'; setupRoleView(); closeDetail(); toast('Switched Role'); }
    function setupRoleView() {
       const r = STATE.user.defaultRole;
       document.getElementById('view-indicator').innerText = r;
       document.getElementById('view-indicator').style.background = r==='CWC'?'var(--status-new)':'var(--status-pharm)';
       document.getElementById('view-indicator').style.color = r==='CWC'?'var(--text-new)':'var(--text-pharm)';
       document.getElementById('btn-add-record').classList.toggle('hidden', r==='PHARMACY');
       
       // Ensure View Switch Button is visible if multiple roles exist OR if it's the admin
       if (STATE.user.roles.length > 1 || STATE.user.email.includes('pierremontalvo')) {
          document.getElementById('btn-switch-role').classList.remove('hidden');
       } else {
          document.getElementById('btn-switch-role').classList.add('hidden');
       }
    }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('cwc_dark_mode', document.body.classList.contains('dark-mode')); }
    function toggleBlur() { STATE.blur=!STATE.blur; localStorage.setItem('cwc_blur_enabled',STATE.blur); renderList(); }
    function toggleInfo(e) { if(e)e.stopPropagation(); document.getElementById('info-modal').classList.toggle('hidden'); }
    function toggleSSN() { const i=document.getElementById('inp-ssn'); i.type=i.type==='password'?'text':'password'; }
    
    // UPDATED TOGGLE FUNCTION WITH EVENT PREVENTION
    function togglePharmSSN(e) { 
      if(e) { e.preventDefault(); e.stopPropagation(); }
      const i=document.getElementById('pharm-ssn-view'); 
      if(i) i.type=i.type==='password'?'text':'password'; 
    }
    
    function handleSearch() { renderList(); }
    function toggleSort() { 
       STATE.sortOrder = STATE.sortOrder === 'asc' ? 'desc' : 'asc'; 
       document.getElementById('btn-sort').innerText = STATE.sortOrder === 'asc' ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'; 
       renderList(); 
    }
    function switchList(t) { 
       STATE.currentList = t; 
       document.getElementById('tab-active').classList.toggle('active', t === 'active'); 
       document.getElementById('tab-archive').classList.toggle('active', t === 'archive'); 
       STATE.selectedId = null; 
       document.getElementById('detail-card').classList.add('hidden'); 
       document.getElementById('empty-state').classList.remove('hidden'); 
       renderList(); 
    }
  </script>
</body>
</html> 
