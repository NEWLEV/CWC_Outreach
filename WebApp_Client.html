<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ... (CSS unchanged) ... */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #3b82f6; --primary-dark: #2563eb; --bg: #f3f4f6; --sidebar: #ffffff;
      --text: #1f2937; --text-light: #6b7280; --border: #e5e7eb; --danger: #ef4444;
      --status-new: #dbeafe; --text-new: #1e40af;
      --status-review: #fef3c7; --text-review: #92400e;
      --status-pharm: #d1fae5; --text-pharm: #065f46;
      --highlight-bg: #eff6ff; --highlight-border: #60a5fa;
    }
    .dark-mode { --bg: #111827; --sidebar: #1f2937; --text: #f9fafb; --text-light: #9ca3af; --border: #374151; --status-new: #1e3a8a; --text-new: #bfdbfe; --highlight-bg: #1e293b; --highlight-border: #3b82f6; }
    html, body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: grid; grid-template-columns: 320px 1fr; }
    aside { background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; height: 100%; overflow: hidden; }
    .sb-header, .search-box, .tabs { flex-shrink: 0; }
    .sb-header { padding: 16px; border-bottom: 1px solid var(--border); }
    .search-box { padding: 12px; display: flex; gap: 8px; align-items: center; }
    #search { flex: 1; min-width: 0; }
    .btn-icon { flex-shrink: 0; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; padding: 0; }
    .tabs { display: flex; padding: 0 12px; border-bottom: 1px solid var(--border); }
    .tab { padding: 10px; cursor: pointer; font-weight: 600; color: var(--text-light); border-bottom: 2px solid transparent; }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .list-container { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; min-height: 0; }
    
    .chat-section { height: 40%; min-height: 200px; border-top: 2px solid var(--border); display: flex; flex-direction: column; background: var(--sidebar); }
    .chat-header { padding: 8px 12px; background: var(--bg); font-size: 11px; font-weight: 700; border-bottom: 1px solid var(--border); color: var(--text-light); display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; font-size: 12px; background: var(--sidebar); }
    .chat-input-area { padding: 8px; border-top: 1px solid var(--border); display: flex; gap: 6px; background: var(--sidebar); }
    .msg { padding: 6px 10px; border-radius: 8px; max-width: 90%; word-wrap: break-word; }
    .msg.system { align-self: center; color: var(--text-light); font-style: italic; font-size: 11px; background: transparent; text-align: center; }
    .msg.out { align-self: flex-end; background: var(--primary); color: white; }
    .msg.in { align-self: flex-start; background: var(--bg); color: var(--text); border: 1px solid var(--border); }
    .dark-mode .msg.in { background: #374151; border-color: #4b5563; }
    .msg-meta { font-size: 9px; opacity: 0.7; margin-bottom: 2px; display: block; }
    
    .patient-item { padding: 12px; margin-bottom: 6px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; border-left: 3px solid transparent; position: relative; }
    .patient-item:hover { background: var(--bg); }
    .patient-item.selected { background: var(--primary); color: white; border-left-color: white; }
    .patient-item.selected .sub-text { color: #e0e7ff; }
    .patient-item.unread { background-color: var(--highlight-bg); border-left-color: var(--highlight-border); animation: pulse-blue 2s infinite; }
    .sub-text { font-size: 11px; color: var(--text-light); display: flex; justify-content: space-between; margin-top: 6px; }
    @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    .unread-badge { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 0 2px var(--sidebar); }
    
    .sb-badge { 
      font-size: 8px; padding: 1px 4px; border-radius: 3px; font-weight: 700; 
      margin-left: 4px; color: white; display: inline-block; vertical-align: middle;
    }
    .ext-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 5px; color: white; display: inline-block; }
    .bg-mail { background-color: #8b5cf6; } 
    .bg-meds { background-color: #ec4899; }
    
    main { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
    header { background: var(--sidebar); padding: 12px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .view-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; background: var(--bg); color: var(--text); border: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
    .live-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #22c55e; display: inline-block; opacity: 0.5; transition: opacity 0.3s; }
    .live-dot.active { opacity: 1; box-shadow: 0 0 5px #22c55e; }
    .content-area { flex: 1; overflow-y: auto; padding: 24px; position: relative; }
    .card { background: var(--sidebar); border-radius: 8px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: opacity 0.2s; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    .form-group { margin-bottom: 10px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: var(--text-light); }
    .full-width { grid-column: 1 / -1; }
    input, select, textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-secondary:hover { background: var(--bg); }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .btn-icon { padding: 6px; font-size: 14px; }
    .hidden { display: none !important; }
    .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; margin-left: 8px; }
    .bg-new { background: var(--status-new); color: var(--text-new); }
    .bg-review { background: var(--status-review); color: var(--text-review); }
    .bg-pharm { background: var(--status-pharm); color: var(--text-pharm); }
    .blurred { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
    .modal-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index: 200; }
    .modal-content { background: var(--sidebar); padding: 25px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px; }
    .loader-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 50; flex-direction: column; }
    .dark-mode .loader-overlay { background: rgba(0,0,0,0.8); }
    .spinner { width: 30px; height: 30px; border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 10px 20px; border-radius: 6px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 100; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    #toast.updated { border-left: 4px solid #3b82f6; }
    
    /* NEW: Pharmacy Info Card Style */
    .pharm-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px; }
    .pharm-item { padding: 8px; border-bottom: 1px solid var(--border); }
    .pharm-item strong { display: block; color: var(--text-light); font-size: 11px; margin-bottom: 4px; text-transform: uppercase; }
    .pharm-item span { font-weight: 500; color: var(--text); }
    .pharm-section-title { grid-column: 1 / -1; margin-top: 15px; font-weight: 700; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 5px; }
  </style>
</head>
<body>
  <aside>
    <div class="sb-header"><h3>CWC Outreach</h3><div class="sub-text" id="user-email">Loading...</div></div>
    <div class="search-box">
      <input type="text" id="search" placeholder="Search Name or PRN..." onkeyup="handleSearch()">
      <button class="btn btn-secondary btn-icon" id="btn-sort" onclick="toggleSort()" title="Sort Date"> ‚¨á Ô∏è</button>
      <button class="btn btn-secondary btn-icon" onclick="toggleBlur()" title="Toggle Privacy Blur"> üëÅ Ô∏è</button>
    </div>
    <div class="tabs">
      <div id="tab-active" class="tab active" onclick="switchList('active')">Active</div>
      <div id="tab-archive" class="tab" onclick="switchList('archive')">Archive</div>
    </div>
    <div id="list-wrapper" class="list-container"></div>
    <div class="chat-section">
      <div class="chat-header">
        <span>GROUP CHAT</span>
        <span onclick="refreshChat()" style="cursor:pointer; font-size:14px;" title="Refresh Chat">‚Üª</span>
      </div>
      <div id="chat-messages" class="chat-messages">
        <div style="text-align:center; color:var(--text-light); padding:20px;">Loading chat...</div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type message..." onkeydown="checkChatSend(event)">
        <button class="btn btn-primary btn-sm" onclick="sendChat()">‚û§</button>
      </div>
    </div>
  </aside>
  <main>
    <header>
      <div class="header-actions">
        <div id="view-indicator" class="view-badge"><span id="live-dot" class="live-dot"></span><span id="view-text">Loading...</span></div>
        <button class="btn btn-primary" id="btn-add-record" onclick="addRecord(event)">+ Add Record</button>
        <button class="btn btn-secondary" id="export-btn" onclick="exportPDF()"> üìÑ  Export PDF</button>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary btn-sm hidden" id="btn-switch-role" onclick="switchRole()"> ‚áÑ  Switch View</button>
        <button class="btn btn-secondary btn-sm" onclick="toggleInfo(event)"> ‚Ñπ  Info</button>
        <button class="btn btn-secondary btn-sm" onclick="init()"> ‚Üª  Refresh</button>
        <label style="font-size:12px; display:flex; align-items:center; gap:5px;"><input id="chk-theme" type="checkbox" onchange="toggleTheme()"> Dark</label>
      </div>
    </header>
    <div class="content-area" id="content-area">
      <div id="empty-state" style="text-align:center; margin-top:80px; color:var(--text-light);">
        <p>Select a record to view details</p>
      </div>
      <div id="detail-card" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px;">
          <div>
             <h2 id="d-name" style="margin:0;">Name</h2>
             <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                <span id="d-prn" class="sub-text">PRN</span>
                <div id="d-ext-status"></div>
             </div>
          </div>
          <span id="d-status" class="badge bg-new">Status</span>
        </div>
        <form id="patient-form">
          <div id="view-cwc-container">
             <div class="tabs" style="margin-top:10px;">
               <div class="tab active" onclick="showSection('patient')">Patient Info</div>
               <div class="tab" onclick="showSection('meds')">Clinical & Meds</div>
             </div>
             
             <div id="sec-patient" class="form-grid">
               <div class="form-group"><label>Patient Name</label><input type="text" name="patientName" required></div>
               <div class="form-group"><label>PRN</label><input type="text" name="prn" required></div>
               <div class="form-group"><label>Priority</label><select name="priority"><option>Standard</option><option>Urgent</option></select></div>
               <div class="form-group">
                 <label>Social Security</label>
                 <div style="position:relative; display:flex;">
                   <input type="password" name="ssn" id="inp-ssn" placeholder="Enter SSN">
                   <button type="button" class="btn btn-secondary btn-sm" style="position:absolute; right:0; top:0; bottom:0; border-left:none;" onclick="toggleSSN()">üëÅÔ∏è</button>
                 </div>
               </div>
               <div class="form-group"><label>DOB</label><input type="date" name="dob"></div>
               <div class="form-group"><label>Sex</label><select name="sex" id="opt-sex"></select></div>
               <div class="form-group"><label>Phone</label><input type="text" name="phoneNumber"></div>
               <div class="form-group"><label>Address</label><input type="text" name="address"></div>
               <div class="form-group full-width"><label>Reason</label><input type="text" name="reason"></div>
               <div class="form-group full-width"><label>Outreach Note</label><textarea name="outreachNote" rows="3"></textarea></div>
               <!-- UPDATED LABEL -->
               <div class="form-group"><label>CWC Staff</label><input type="text" name="creatorEmail" disabled style="background:var(--border); opacity:0.7;"></div>
             </div>
             
             <div id="sec-meds" class="form-grid hidden">
               <div class="form-group"><label>Pharmacy</label><select name="pharmacy" id="opt-pharmacy"></select></div>
               <div class="form-group"><label>Provider</label><select name="provider" id="opt-provider"></select></div>
               <div class="form-group"><label>Medication</label><select name="medicationDetails" id="opt-medication"></select></div>
               <div class="form-group"><label>Status</label><select name="status" id="opt-status"></select></div>
               <div class="form-group"><label>Insurance</label><select name="insuranceName" id="opt-insurance"></select></div>
               <div class="form-group"><label>Insurance ID</label><input type="text" name="insuranceId"></div>
               <div class="form-group full-width"><label>Additional Notes</label><textarea name="officeNote" rows="3"></textarea></div>
             </div>
          </div>
          
          <div id="view-pharm-container" class="hidden">
             <div class="pharm-info-grid" id="pharm-info-card"></div>
             <div class="pharm-section-title">Pharmacy Input</div>
             <div class="form-grid" style="margin-top:10px;">
               <div class="form-group"><label>Need Script?</label><select name="needsScript" id="opt-needsScript"></select></div>
               <div class="form-group"><label>Updated Insurance</label><select name="insuranceDetail" id="opt-insurance-update"></select></div>
               <div class="form-group full-width"><label>Pharmacy Notes</label><textarea name="gardenNotes" rows="2"></textarea></div>
             </div>
          </div>

          <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border); display:flex; gap:10px;">
            <button type="button" class="btn btn-primary" id="btn-save" onclick="saveData('Save')">Save</button>
            <button type="button" class="btn btn-secondary" id="btn-submit" onclick="saveData('Submit to Pharmacy')">Submit to Pharmacy</button>
            <button type="button" class="btn btn-secondary" id="btn-outreach" onclick="saveData('Outreach Update')">Send Outreach Update</button>
            <button type="button" class="btn btn-primary hidden" id="btn-pharm-update" onclick="saveData('Pharmacy Update')">Submit Pharmacy Update</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <div id="loader" class="loader-overlay hidden"><div class="spinner"></div><p style="margin-top:10px; font-weight:500;">Loading...</p></div>
  <div id="toast">Notification</div>
  <div id="info-modal" class="modal-backdrop hidden" onclick="toggleInfo(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header"><h2>Guide</h2><button class="btn btn-sm btn-secondary" onclick="toggleInfo(event)">Close</button></div>
      <div style="line-height:1.6; color:var(--text);">
        <p><strong>Priority:</strong> Select 'Urgent' to bump record to top.</p>
        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        <h4>Connection Status</h4>
        <div id="connection-log" style="font-family:monospace; font-size:11px; background:#f3f4f6; padding:10px; border-radius:4px; margin-top:5px; max-height:200px; overflow-y:auto; white-space: pre-wrap;">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    let STATE = { records: [], archives: [], config: {}, user: {}, currentList: 'active', blur: true, selectedId: null, dataHash: "", unreadIds: new Set(), sortOrder: 'asc', chatHistory: [], externalStatus: {} };
    let pollInterval, chatInterval, notificationTimer, originalTitle = document.title;
    window.onload = init;

    function loadSettings() {
       const savedTheme = localStorage.getItem('cwc_dark_mode');
       if(savedTheme === 'true') {
         document.body.classList.add('dark-mode');
         document.getElementById('chk-theme').checked = true;
       }
       const savedSort = localStorage.getItem('cwc_sort_order');
       if(savedSort) STATE.sortOrder = savedSort;
       document.getElementById('btn-sort').innerText = STATE.sortOrder === 'asc' ? ' ‚¨á Ô∏è' : ' ‚¨Ü Ô∏è';
       const savedBlur = localStorage.getItem('cwc_blur_enabled');
       if(savedBlur !== null) STATE.blur = (savedBlur === 'true');
    }

    document.addEventListener('click', (e) => {
      if (typeof AudioContext !== 'undefined' && AudioContext.state === 'suspended') new AudioContext().resume();
      const dc = document.getElementById('detail-card'), lw = document.getElementById('list-wrapper'), h = document.querySelector('header');
      if(STATE.selectedId && dc && lw && h && !dc.contains(e.target) && !lw.contains(e.target) && !h.contains(e.target) && !e.target.closest('.modal-content') && !e.target.closest('.chat-section')) {
        STATE.selectedId = null; dc.classList.add('hidden'); document.getElementById('empty-state').classList.remove('hidden'); renderList();
      }
    });
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') { if(!document.getElementById('info-modal').classList.contains('hidden')) toggleInfo(); else if(STATE.selectedId) { STATE.selectedId = null; document.getElementById('detail-card').classList.add('hidden'); document.getElementById('empty-state').classList.remove('hidden'); renderList(); } }
    });

    function init() {
      loadSettings();
      toggleLoader(true);
      google.script.run
        .withSuccessHandler(data => {
          toggleLoader(false);
          if(data.error) return alert(data.error);
          try {
            STATE.records = data.activeRecords || [];
            STATE.archives = data.archivedRecords || [];
            STATE.config = data.config || {};
            STATE.user = data.user || { email: 'Guest', defaultRole: 'CWC', roles: [] };
            STATE.dataHash = data.dataHash || "";
            STATE.chatHistory = data.chatHistory || [];
            STATE.externalStatus = data.externalStatus || {}; 
            
            const diagEl = document.getElementById('connection-log');
            if (data.diagnostics && data.diagnostics.length > 0) {
               diagEl.innerHTML = data.diagnostics.join('<br>');
            } else {
               diagEl.innerText = "No diagnostics info returned.";
            }

            document.getElementById('user-email').innerText = STATE.user.email;
            const dd = data.config?.dropdowns || {};
            ['sex','pharmacy','provider','medication','status','insurance','needsScript'].forEach(k => populateSelect('opt-'+k, dd[k] || []));
            populateSelect('opt-insurance-update', dd.insurance || []);
            setupRoleView();
            renderList();
            renderChat();
            if(pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(checkUpdates, 15000);
            if(chatInterval) clearInterval(chatInterval);
            chatInterval = setInterval(refreshChat, 30000);
          } catch (err) {
            console.error(err);
            alert("Error initializing app: " + err.message);
          }
        })
        .withFailureHandler(err => {
          toggleLoader(false);
          alert("Server Error: " + err.message);
        })
        .getInitialData();
    }

    function checkUpdates() {
      const dot = document.getElementById('live-dot'); if(dot) { dot.classList.add('active'); setTimeout(() => dot.classList.remove('active'), 500); }
      google.script.run.withSuccessHandler(res => {
        if(res.externalStatus) {
           STATE.externalStatus = res.externalStatus;
           if (STATE.selectedId) {
               const currentRecord = STATE.records.find(r => r.rowNum === STATE.selectedId);
               if(currentRecord) updateHeaderBadges(currentRecord); 
           }
        }
      
        if(res.hasUpdate) {
          const getStableId = (r) => (r.timestamp||'')+(r.patientName||'')+(r.prn||'');
          const oldMap = new Map(); STATE.records.forEach(r => oldMap.set(getStableId(r), r.workflowStatus));
          res.activeRecords.forEach(r => {
            const id = getStableId(r);
            const oldStatus = oldMap.get(id);
            if (oldStatus === undefined || oldStatus !== r.workflowStatus) STATE.unreadIds.add(r.rowNum);
          });
          STATE.records = res.activeRecords; STATE.dataHash = res.dataHash; renderList();
          
          const curIds = new Set(STATE.records.map(r => r.rowNum));
          STATE.unreadIds = new Set([...STATE.unreadIds].filter(x => curIds.has(x)));
          const relevant = [...STATE.unreadIds].filter(rn => {
            const rec = STATE.records.find(r => r.rowNum === rn);
            if(!rec) return false;
            if (STATE.user.defaultRole === 'PHARMACY') return rec.workflowStatus === STATE.config.flags.SUBMITTED_TO_PHARMACY || rec.workflowStatus === STATE.config.flags.PHARMACY_UPDATE;
            return true;
          });
          
          if(relevant.length > 0 && !STATE.selectedId) { 
             playSound(); 
             toast("Updates Available", "updated"); 
             document.title = `(${relevant.length}) New`; 
             if (!notificationTimer) {
               notificationTimer = setInterval(() => {
                  if (!STATE.selectedId) playSound(); 
               }, 60000);
             }
          }
        }
      }).checkForUpdates(STATE.dataHash);
    }

    function renderChat() {
      const c = document.getElementById('chat-messages');
      c.innerHTML = '';
      STATE.chatHistory.forEach(msg => {
        const div = document.createElement('div');
        const isMe = msg.sender === STATE.user.email;
        const isSys = msg.sender === 'System';
        let cls = 'in';
        if(isMe) cls = 'out';
        if(isSys) cls = 'system';
        div.className = `msg ${cls}`;
        div.innerHTML = `<span class="msg-meta">${isSys ? 'Bot' : msg.sender.split('@')[0]} ‚Ä¢ ${msg.time}</span>${msg.text}`;
        c.appendChild(div);
      });
      c.scrollTop = c.scrollHeight;
    }

    function checkChatSend(e) { if(e.key === 'Enter') sendChat(); }

    function sendChat() {
      const inp = document.getElementById('chat-input');
      const txt = inp.value.trim();
      if(!txt) return;
      const now = new Date();
      STATE.chatHistory.push({
        time: now.getHours() + ':' + now.getMinutes(),
        sender: STATE.user.email,
        text: txt
      });
      renderChat();
      inp.value = '';
      google.script.run.withSuccessHandler(history => {
        STATE.chatHistory = history;
        renderChat();
      }).postUserMessage(txt);
    }

    function refreshChat() {
      google.script.run.withSuccessHandler(h => {
        if(h && h.length) {
          STATE.chatHistory = h;
          renderChat();
        }
      }).pollChat();
    }

    function setupRoleView() {
      const r = STATE.user.defaultRole;
      document.getElementById('view-text').innerText = `Viewing: ${r === 'CWC' ? 'CWC' : 'Pharmacy'}`;
      document.getElementById('view-indicator').style.background = r === 'CWC' ? 'var(--status-new)' : 'var(--status-pharm)';
      document.getElementById('view-indicator').style.color = r === 'CWC' ? 'var(--text-new)' : 'var(--text-pharm)';
      document.getElementById('btn-add-record').classList.toggle('hidden', r === 'PHARMACY');
      if (STATE.user.roles.length > 1) document.getElementById('btn-switch-role').classList.remove('hidden');
      const isPharm = r === 'PHARMACY';
      document.getElementById('tab-archive').classList.toggle('hidden', isPharm);
      if(isPharm && STATE.currentList === 'archive') {
         switchList('active');
      }
    }
    
    function switchRole() {
      STATE.user.defaultRole = STATE.user.defaultRole === 'CWC' ? 'PHARMACY' : 'CWC';
      STATE.selectedId = null;
      document.getElementById('detail-card').classList.add('hidden');
      document.getElementById('empty-state').classList.remove('hidden');
      setupRoleView(); renderList(); toast(`Switched View`);
    }
    
    function toggleSort() { 
        STATE.sortOrder = STATE.sortOrder === 'asc' ? 'desc' : 'asc'; 
        localStorage.setItem('cwc_sort_order', STATE.sortOrder);
        document.getElementById('btn-sort').innerText = STATE.sortOrder === 'asc' ? ' ‚¨á Ô∏è' : ' ‚¨Ü Ô∏è'; 
        renderList(); 
    }
    
    function formatTime(s) { if(!s) return ""; const d = new Date(s); return isNaN(d) ? s : d.toLocaleDateString('en-US')+', '+d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}); }
    
    function renderList() {
      const listEl = document.getElementById('list-wrapper'); listEl.innerHTML = '';
      let src = STATE.currentList === 'active' ? STATE.records : STATE.archives;
      const term = document.getElementById('search').value.toLowerCase();
      let filt = src.filter(r => (r.patientName||'').toLowerCase().includes(term) || (r.prn||'').toLowerCase().includes(term));
      if(STATE.user.defaultRole === 'PHARMACY' && STATE.currentList === 'active') {
        filt = filt.filter(r => r.workflowStatus === STATE.config.flags.SUBMITTED_TO_PHARMACY || r.workflowStatus === STATE.config.flags.PHARMACY_UPDATE);
      }
      filt.sort((a, b) => {
        const pA = (a.priority||'').toLowerCase() === 'urgent' ? 1 : 0;
        const pB = (b.priority||'').toLowerCase() === 'urgent' ? 1 : 0;
        if(pA !== pB) return pB - pA;
        const dA = new Date(a.timestamp||0), dB = new Date(b.timestamp||0);
        return STATE.sortOrder === 'asc' ? dA - dB : dB - dA;
      });
      filt.forEach(r => {
        const div = document.createElement('div');
        const unread = STATE.unreadIds.has(r.rowNum);
        div.className = `patient-item ${STATE.selectedId === r.rowNum ? 'selected' : ''} ${unread ? 'unread' : ''}`;
        div.onclick = (e) => { e.stopPropagation(); selectRecord(r); };
        
        let extBadgesHTML = '';
        const prnKey = r.prn ? r.prn.toUpperCase().replace(/\s+/g, '') : "";
        if (prnKey && STATE.externalStatus[prnKey]) {
           STATE.externalStatus[prnKey].forEach(status => {
             const isMail = status === 'MAIL';
             const text = isMail ? 'MAIL' : 'MEDS';
             const bgClass = isMail ? 'bg-mail' : 'bg-meds';
             extBadgesHTML += `<span class="sb-badge ${bgClass}">${text}</span>`;
           });
        }

        let cls = 'bg-new';
        if(r.workflowStatus.includes('Review')) cls = 'bg-review';
        if(r.workflowStatus.includes('Pharmacy')) cls = 'bg-pharm';
        let icon = (r.priority||'').toLowerCase() === 'urgent' ? ' üî• ' : '';
        div.innerHTML = `${unread ? '<div class="unread-badge"></div>' : ''}
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;">
             <strong class="${STATE.blur && STATE.selectedId !== r.rowNum ? 'blurred' : ''}">${icon} ${r.patientName||'Unknown'}</strong>
             ${extBadgesHTML}
          </div>
          <span class="badge ${cls}">${r.workflowStatus?r.workflowStatus.substring(0,1).toUpperCase():'N'}</span>
        </div>
        <div class="sub-text"><span>${r.prn||'N/A'}</span><span>${formatTime(r.timestamp)}</span></div>`;
        listEl.appendChild(div);
      });
    }

    function switchList(t) { STATE.currentList = t; document.getElementById('tab-active').classList.toggle('active', t === 'active'); document.getElementById('tab-archive').classList.toggle('active', t === 'archive'); STATE.selectedId = null; document.getElementById('detail-card').classList.add('hidden'); document.getElementById('empty-state').classList.remove('hidden'); renderList(); }
    function handleSearch() { renderList(); }
    function toggleBlur() { STATE.blur = !STATE.blur; localStorage.setItem('cwc_blur_enabled', STATE.blur); renderList(); }
    
    function selectRecord(r) {
      if (notificationTimer) {
        clearInterval(notificationTimer);
        notificationTimer = null;
      }
      if(STATE.unreadIds.has(r.rowNum)) { STATE.unreadIds.delete(r.rowNum); document.title = originalTitle; }
      if(STATE.currentList === 'archive') {
        toggleLoader(true);
        google.script.run
          .withSuccessHandler(res => {
             toggleLoader(false);
             if(res.error) {
                toast("Error: " + res.error, 'error');
             } else if(res.record) {
                populateForm(res.record);
             }
          })
          .withFailureHandler(e => {
             toggleLoader(false);
             toast("System Error: " + e.message, 'error');
          })
          .getFullArchivedRecord(r.rowNum);
      } else populateForm(r);
    }
    
    function toggleSSN() {
      const inp = document.getElementById('inp-ssn');
      inp.type = inp.type === 'password' ? 'text' : 'password';
    }

    function populateForm(r) {
      STATE.selectedId = r.rowNum; renderList();
      document.getElementById('empty-state').classList.add('hidden'); document.getElementById('detail-card').classList.remove('hidden');
      
      document.getElementById('d-name').innerText = r.patientName; 
      document.getElementById('d-prn').innerText = r.prn; 
      document.getElementById('d-status').innerText = r.workflowStatus;
      updateHeaderBadges(r);

      const isPharm = STATE.user.defaultRole === 'PHARMACY';
      const isArchive = STATE.currentList === 'archive';
      
      const form = document.getElementById('patient-form');
      const cwcContainer = document.getElementById('view-cwc-container');
      const pharmContainer = document.getElementById('view-pharm-container');

      // 1. Populate Data
      Array.from(form.elements).forEach(el => {
        if(el.name && r[el.name] !== undefined) {
           if(el.type==='date' && r[el.name]) try{ el.value=new Date(r[el.name]).toISOString().split('T')[0];}catch(e){el.value=r[el.name];}
           else el.value = r[el.name];
        }
      });

      // 2. Switch View Mode
      if (isPharm) {
        cwcContainer.classList.add('hidden');
        pharmContainer.classList.remove('hidden');
        
        const card = document.getElementById('pharm-info-card');
        card.innerHTML = `
          <div class="pharm-item"><strong>SSN</strong><span>${r.ssn || 'N/A'}</span></div>
          <div class="pharm-item"><strong>DOB</strong><span>${r.dob ? new Date(r.dob).toLocaleDateString() : 'N/A'}</span></div>
          <div class="pharm-item"><strong>Sex</strong><span>${r.sex || '-'}</span></div>
          <div class="pharm-item"><strong>Phone</strong><span>${r.phoneNumber || '-'}</span></div>
          <div class="pharm-item"><strong>Address</strong><span>${r.address || '-'}</span></div>
          <div class="pharm-item"><strong>Medication</strong><span>${r.medicationDetails || '-'}</span></div>
          <div class="pharm-item"><strong>Insurance</strong><span>${r.insuranceName || '-'}</span></div>
          <div class="pharm-item"><strong>Ins ID</strong><span>${r.insuranceId || '-'}</span></div>
          <div class="pharm-item" style="grid-column:1/-1;"><strong>Reason</strong><span>${r.reason || '-'}</span></div>
          <div class="pharm-item" style="grid-column:1/-1;"><strong>Outreach Note</strong><span>${r.outreachNote || 'No notes'}</span></div>
          <div class="pharm-item" style="grid-column:1/-1;"><strong>Office Note</strong><span>${r.officeNote || 'No notes'}</span></div>
        `;
      } else {
        cwcContainer.classList.remove('hidden');
        pharmContainer.classList.add('hidden');
      }

      // 3. Button & Field Access
      document.getElementById('btn-save').classList.toggle('hidden', isPharm || isArchive);
      document.getElementById('btn-submit').classList.toggle('hidden', isPharm || isArchive);
      document.getElementById('btn-outreach').classList.toggle('hidden', isPharm || isArchive);
      document.getElementById('btn-pharm-update').classList.toggle('hidden', !isPharm || isArchive);

      form.querySelectorAll('input, select, textarea').forEach(i => {
        i.disabled = isArchive;
        if (!isArchive) {
          const isPharmField = ['needsScript','insuranceDetail','gardenNotes'].includes(i.name);
          if (isPharm) {
             i.disabled = !isPharmField; 
          } else {
             i.disabled = isPharmField || i.name === 'creatorEmail';
          }
        }
      });
    }
    
    function updateHeaderBadges(r) {
      const c = document.getElementById('d-ext-status'); c.innerHTML = '';
      const k = r.prn ? r.prn.toUpperCase().replace(/\s+/g, '') : "";
      if (k && STATE.externalStatus[k]) {
        STATE.externalStatus[k].forEach(s => {
           const sp = document.createElement('span');
           sp.className = 'ext-badge ' + (s === 'MAIL' ? 'bg-mail' : 'bg-meds');
           sp.innerText = s;
           c.appendChild(sp);
        });
      }
    }

    function showSection(s) {
      document.getElementById('sec-patient').classList.toggle('hidden', s !== 'patient');
      document.getElementById('sec-meds').classList.toggle('hidden', s !== 'meds');
      document.querySelectorAll('#view-cwc-container .tab').forEach(t => t.classList.remove('active')); 
      event.target.classList.add('active');
    }

    function addRecord(e) {
      if(e) e.stopPropagation();
      if(STATE.user.defaultRole !== 'CWC') return toast('Access Denied', 'error');
      toggleLoader(true);
      google.script.run.withSuccessHandler(res => {
        toggleLoader(false); if(res.error) return toast(res.error, 'error');
        STATE.records = res.allRecords; STATE.dataHash = res.dataHash;
        if(res.externalStatus) STATE.externalStatus = res.externalStatus;
        
        renderList();
        if(STATE.sortOrder === 'asc') setTimeout(() => { const l = document.getElementById('list-wrapper'); if(l) l.scrollTop = l.scrollHeight; }, 100);
        selectRecord(res.updatedRecord); toast('Record Created');
      })
      .withFailureHandler(e => { toggleLoader(false); toast("Err: "+e.message, 'error'); })
      .addOutreachRecord();
    }

    function saveData(act) {
      if(!STATE.selectedId) return;
      const f = document.getElementById('patient-form'), d = {};
      Array.from(f.elements).forEach(el => { if(el.name) d[el.name] = el.value; });
      if(STATE.config.flags.NEW_ENTRY === document.getElementById('d-status').innerText) {
        const nm = d.patientName||'', pr = d.prn||'';
        const dup = STATE.records.some(r => r.rowNum !== STATE.selectedId && ((r.patientName && r.patientName.toLowerCase()===nm.toLowerCase()) || (r.prn && r.prn===pr)));
        if(dup && !confirm("Duplicate detected. Save anyway?")) return;
      }
      toggleLoader(true);
      let h = 'saveRecordChanges';
      if(act === 'Submit to Pharmacy') h = 'submitToPharmacy'; else if(act === 'Outreach Update') h = 'sendOutreachUpdate';
      else if(act === 'Pharmacy Update') h = 'submitPharmacyUpdate';

      google.script.run.withSuccessHandler(res => {
        toggleLoader(false); if(res.error) return toast(res.error, 'error');
        STATE.records = res.allRecords; STATE.dataHash = res.dataHash;
        
        if(res.externalStatus) STATE.externalStatus = res.externalStatus;

        if(res.chatHistory) {
            STATE.chatHistory = res.chatHistory;
            renderChat();
        }

        const updated = STATE.records.find(r => r.rowNum === STATE.selectedId);
        if(updated) populateForm(updated);
        toast(res.message || 'Saved Successfully');
      })
      .withFailureHandler(e => { toggleLoader(false); toast("Err: "+e.message, 'error'); })
      [h](STATE.selectedId, d);
    }

    function exportPDF() { toggleLoader(true); google.script.run.withSuccessHandler(res => { toggleLoader(false); if(res.error) toast("Error: "+res.error, 'error'); else window.open(res.url, '_blank'); }).getPDFDownloadUrl(); }
    function populateSelect(id, o) { const s = document.getElementById(id); s.innerHTML = '<option>-- Select --</option>';
      if(o) o.forEach(v => { const op = document.createElement('option'); op.value = v; op.innerText = v; s.appendChild(op); }); }
    function toggleLoader(s) { document.getElementById('loader').classList.toggle('hidden', !s); }
    function toast(m, t='normal') { const el = document.getElementById('toast'); el.innerText = m; el.className = t; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 3000); }
    function toggleTheme() { 
        document.body.classList.toggle('dark-mode'); 
        localStorage.setItem('cwc_dark_mode', document.body.classList.contains('dark-mode'));
    }
    function toggleInfo(e) { if(e) e.stopPropagation(); document.getElementById('info-modal').classList.toggle('hidden'); }
    function playSound() { const a = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg"); a.play().catch(e => {}); }
  </script>
</body>
</html>
